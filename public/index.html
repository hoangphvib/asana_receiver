<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asana Webhook Receiver - Real-time Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 20px 30px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .header h1 {
      color: #333;
      margin-bottom: 10px;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .status-badge {
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 14px;
      font-weight: 500;
    }

    .status-connected {
      background: #c6f6d5;
      color: #22543d;
    }

    .status-disconnected {
      background: #fed7d7;
      color: #742a2a;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .card h2 {
      color: #333;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-danger {
      background: #f56565;
      color: white;
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .event-list {
      max-height: 600px;
      overflow-y: auto;
    }

    .event-item {
      background: #f7fafc;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      transition: all 0.3s;
    }

    .event-item:hover {
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .event-item.new {
      animation: slideIn 0.5s ease-out;
      border-left-color: #48bb78;
    }

    @keyframes slideIn {
      from {
        transform: translateX(-20px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .event-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 10px;
    }

    .event-title {
      font-weight: 600;
      color: #2d3748;
      font-size: 16px;
    }

    .event-time {
      font-size: 12px;
      color: #718096;
    }

    .event-details {
      font-size: 14px;
      color: #4a5568;
      line-height: 1.6;
    }

    .event-details div {
      margin-bottom: 5px;
    }

    .event-details strong {
      color: #2d3748;
      margin-right: 5px;
    }

    .toggle-details {
      margin-top: 10px;
      font-size: 13px;
      color: #667eea;
      cursor: pointer;
      user-select: none;
    }

    .toggle-details:hover {
      text-decoration: underline;
    }

    .event-raw {
      margin-top: 10px;
      padding: 10px;
      background: #1e1e1e;
      color: #d4d4d4;
      border-radius: 5px;
      font-size: 12px;
      overflow-x: auto;
      display: none;
    }

    .event-raw.show {
      display: block;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #718096;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .alert {
      padding: 12px 15px;
      border-radius: 5px;
      margin-bottom: 15px;
    }

    .alert-info {
      background: #bee3f8;
      border-left: 4px solid #3182ce;
      color: #2c5282;
    }

    .alert-success {
      background: #c6f6d5;
      border-left: 4px solid #38a169;
      color: #22543d;
    }

    footer {
      text-align: center;
      color: white;
      margin-top: 30px;
      font-size: 14px;
    }

    /* Tab styles */
    .tabs {
      display: flex;
      gap: 10px;
      border-bottom: 2px solid #e2e8f0;
      margin-bottom: 20px;
    }

    .tab {
      padding: 12px 24px;
      cursor: pointer;
      font-weight: 500;
      color: #718096;
      border: none;
      background: transparent;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
      font-size: 15px;
    }

    .tab:hover {
      color: #667eea;
      background: #f7fafc;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
      background: #f7fafc;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Database viewer styles */
    .filter-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-bar select,
    .filter-bar input {
      padding: 8px 12px;
      border: 1px solid #cbd5e0;
      border-radius: 5px;
      font-size: 14px;
    }

    .filter-bar input {
      flex: 1;
      min-width: 200px;
    }

    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e2e8f0;
    }

    .pagination-info {
      color: #718096;
      font-size: 14px;
    }

    .pagination-controls {
      display: flex;
      gap: 10px;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .stat-card h3 {
      font-size: 14px;
      font-weight: 500;
      opacity: 0.9;
      margin-bottom: 8px;
    }

    .stat-card .stat-value {
      font-size: 32px;
      font-weight: 700;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #718096;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Enriched event styles */
    .enrichment-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .enrichment-found {
      background: #c6f6d5;
      color: #22543d;
    }

    .enrichment-not-found {
      background: #fed7d7;
      color: #742a2a;
    }

    .enriched-data {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 5px;
      padding: 12px;
      margin-top: 10px;
    }

    .enriched-section {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e0e7ff;
    }

    .enriched-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .enriched-section h4 {
      font-size: 13px;
      font-weight: 600;
      color: #1e40af;
      margin-bottom: 8px;
    }

    .enriched-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 6px 12px;
      font-size: 13px;
    }

    .enriched-label {
      font-weight: 600;
      color: #4b5563;
    }

    .enriched-value {
      color: #1f2937;
    }

    .customer-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîî Asana Webhook Receiver - Real-time Dashboard</h1>
      <div class="status">
        <span class="status-badge" id="connectionStatus">Connecting...</span>
        <span style="color: #718096;">Events received: <strong id="eventCount">0</strong></span>
        <span style="color: #718096;">Connected clients: <strong id="clientCount">1</strong></span>
      </div>
    </div>

    <div class="card">
      <div class="alert alert-info">
        <strong>üì° Live Connection:</strong> This dashboard shows webhook events in real-time via Server-Sent Events (SSE).
        Events are automatically pushed from the server as they arrive from Asana.
      </div>
      <div id="urlInfo" style="margin-top: 10px; padding: 12px; background: #f7fafc; border-radius: 5px; font-size: 14px;">
        <strong>üîó Quick Copy URLs:</strong>
        <div style="margin-top: 8px; display: flex; flex-direction: column; gap: 8px;">
          <div>
            <strong>Webhook Endpoint:</strong> 
            <code id="webhookUrl" style="background: white; padding: 4px 8px; border-radius: 3px; cursor: pointer;" onclick="copyUrl('webhookUrl')">
            </code>
            <button class="btn btn-primary" style="margin-left: 8px; padding: 4px 12px; font-size: 12px;" onclick="copyUrl('webhookUrl')">
              üìã Copy
            </button>
          </div>
          <div>
            <strong>Dashboard URL:</strong> 
            <code id="dashboardUrl" style="background: white; padding: 4px 8px; border-radius: 3px; cursor: pointer;" onclick="copyUrl('dashboardUrl')">
            </code>
            <button class="btn btn-primary" style="margin-left: 8px; padding: 4px 12px; font-size: 12px;" onclick="copyUrl('dashboardUrl')">
              üìã Copy
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <button class="tab active" onclick="switchTab('realtime')">üì° Real-time Events</button>
        <button class="tab" onclick="switchTab('enriched')">‚ú® Enriched Events</button>
        <button class="tab" onclick="switchTab('database')">üíæ Database History</button>
        <button class="tab" onclick="switchTab('stats')">üìä Statistics</button>
      </div>

      <!-- Real-time Events Tab -->
      <div id="tab-realtime" class="tab-content active">
      <h2>
          <span>üì® Recent Events (In-Memory)</span>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-primary" onclick="clearEvents()">üóëÔ∏è Clear History</button>
        </div>
      </h2>
      
      <div id="eventList" class="event-list">
        <div class="empty-state">
          <div class="empty-state-icon">‚è≥</div>
          <h3>Waiting for webhook events...</h3>
          <p>Events will appear here automatically when received from Asana</p>
          </div>
        </div>
      </div>

      <!-- Enriched Events Tab -->
      <div id="tab-enriched" class="tab-content">
        <h2>
          <span>‚ú® Enriched Events (with DCT Data)</span>
          <button class="btn btn-primary" onclick="refreshEnriched()">üîÑ Refresh</button>
        </h2>

        <div class="alert alert-info" id="dct-connection-status">
          <strong>üìä DCT Database:</strong> <span id="dct-status-text">Checking connection...</span>
        </div>

        <div class="filter-bar">
          <select id="filterResourceTypeEnriched" onchange="refreshEnriched()">
            <option value="">All Resource Types</option>
            <option value="task">Task</option>
            <option value="project">Project</option>
            <option value="story">Story</option>
            <option value="tag">Tag</option>
            <option value="workspace">Workspace</option>
          </select>
          
          <select id="filterActionEnriched" onchange="refreshEnriched()">
            <option value="">All Actions</option>
            <option value="added">Added</option>
            <option value="changed">Changed</option>
            <option value="removed">Removed</option>
            <option value="deleted">Deleted</option>
          </select>

          <select id="pageSizeEnriched" onchange="refreshEnriched()">
            <option value="20">20 per page</option>
            <option value="50" selected>50 per page</option>
            <option value="100">100 per page</option>
          </select>

          <label style="display: flex; align-items: center; gap: 5px;">
            <input type="checkbox" id="showOnlyMapped" onchange="refreshEnriched()">
            <span>Only show events found in DCT</span>
          </label>
        </div>
        
        <div id="enrichedEventList" class="event-list">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading enriched events...</p>
          </div>
        </div>

        <div class="pagination" id="paginationEnriched" style="display: none;">
          <div class="pagination-info">
            Showing <strong id="pageStartEnriched">0</strong> - <strong id="pageEndEnriched">0</strong> of <strong id="totalEnrichedEvents">0</strong> events
          </div>
          <div class="pagination-controls">
            <button class="btn btn-primary" onclick="previousPageEnriched()" id="btnPrevEnriched">‚Üê Previous</button>
            <button class="btn btn-primary" onclick="nextPageEnriched()" id="btnNextEnriched">Next ‚Üí</button>
          </div>
        </div>
      </div>

      <!-- Database History Tab -->
      <div id="tab-database" class="tab-content">
        <h2>
          <span>üíæ Database Event History</span>
          <button class="btn btn-primary" onclick="refreshDatabase()">üîÑ Refresh</button>
        </h2>

        <div class="filter-bar">
          <select id="filterResourceType" onchange="refreshDatabase()">
            <option value="">All Resource Types</option>
            <option value="task">Task</option>
            <option value="project">Project</option>
            <option value="story">Story</option>
            <option value="tag">Tag</option>
            <option value="workspace">Workspace</option>
          </select>
          
          <select id="filterAction" onchange="refreshDatabase()">
            <option value="">All Actions</option>
            <option value="added">Added</option>
            <option value="changed">Changed</option>
            <option value="removed">Removed</option>
            <option value="deleted">Deleted</option>
          </select>

          <input type="text" id="filterResourceGid" placeholder="Filter by Resource GID..." onchange="refreshDatabase()">

          <select id="pageSize" onchange="refreshDatabase()">
            <option value="20">20 per page</option>
            <option value="50" selected>50 per page</option>
            <option value="100">100 per page</option>
            <option value="200">200 per page</option>
          </select>
        </div>
        
        <div id="databaseEventList" class="event-list">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading events from database...</p>
          </div>
        </div>

        <div class="pagination" id="pagination" style="display: none;">
          <div class="pagination-info">
            Showing <strong id="pageStart">0</strong> - <strong id="pageEnd">0</strong> of <strong id="totalEvents">0</strong> events
          </div>
          <div class="pagination-controls">
            <button class="btn btn-primary" onclick="previousPage()" id="btnPrev">‚Üê Previous</button>
            <button class="btn btn-primary" onclick="nextPage()" id="btnNext">Next ‚Üí</button>
          </div>
        </div>
      </div>

      <!-- Statistics Tab -->
      <div id="tab-stats" class="tab-content">
        <h2>
          <span>üìä Database Statistics</span>
          <button class="btn btn-primary" onclick="refreshStats()">üîÑ Refresh</button>
        </h2>

        <div id="statsContent">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading statistics...</p>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <p>Asana Webhook Receiver with SSE | Real-time Event Streaming</p>
    </footer>
  </div>

  <script>
    let eventSource = null;
    let eventCount = 0;
    let currentPage = 0;
    let currentPageSize = 50;
    let totalDbEvents = 0;
    let currentFilters = {
      resourceType: '',
      action: '',
      resourceGid: ''
    };
    
    // Enriched events state
    let currentPageEnriched = 0;
    let dctConnected = false;

    // Initialize URLs from client-side (more accurate than server-side PUBLIC_URL)
    const currentOrigin = window.location.origin;
    const webhookUrl = currentOrigin + '/webhook';
    const dashboardUrl = currentOrigin;
    
    // Set URLs immediately
    document.getElementById('webhookUrl').textContent = webhookUrl;
    document.getElementById('dashboardUrl').textContent = dashboardUrl;

    // Function to copy URL to clipboard
    function copyUrl(elementId) {
      const element = document.getElementById(elementId);
      const text = element.textContent.trim();
      
      if (!text) return;
      
      navigator.clipboard.writeText(text).then(() => {
        const btn = element.nextElementSibling;
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ Copied!';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy URL');
      });
    }

    // Connect to SSE endpoint
    function connectSSE() {
      eventSource = new EventSource('/events');

      eventSource.onopen = () => {
        console.log('‚úÖ SSE Connected');
        updateConnectionStatus(true);
      };

      eventSource.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data);
          handleServerMessage(data);
        } catch (error) {
          console.error('Error parsing SSE message:', error);
        }
      };

      eventSource.onerror = (error) => {
        console.error('‚ùå SSE Error:', error);
        updateConnectionStatus(false);
        
        // Reconnect after 5 seconds
        setTimeout(() => {
          console.log('üîÑ Reconnecting...');
          connectSSE();
        }, 5000);
      };
    }

    function handleServerMessage(data) {
      console.log('üì® Server message:', data.type, data);

      switch (data.type) {
        case 'connected':
          console.log('‚úÖ Connected to server');
          break;

        case 'history':
          console.log(`üìö Received ${data.count} historical events`);
          data.events.forEach(event => displayEvent(event, false));
          break;

        case 'webhook_event':
          console.log('üîî New webhook event:', data.event);
          displayEvent(data.event, true);
          eventCount++;
          updateEventCount();
          break;

        case 'handshake':
          displayHandshake(data);
          break;

        case 'history_cleared':
          clearEventList();
          break;

        default:
          console.log('Unknown message type:', data.type);
      }
    }

    function displayEvent(event, isNew = false) {
      const eventList = document.getElementById('eventList');
      
      // Remove empty state if exists
      const emptyState = eventList.querySelector('.empty-state');
      if (emptyState) {
        emptyState.remove();
      }

      const eventItem = document.createElement('div');
      eventItem.className = `event-item ${isNew ? 'new' : ''}`;
      
      const actionIcon = getActionIcon(event.action);
      const resourceIcon = getResourceIcon(event.resource_type);

      eventItem.innerHTML = `
        <div class="event-header">
          <div class="event-title">
            ${actionIcon} ${event.action} - ${resourceIcon} ${event.resource_type}
          </div>
          <div class="event-time">${formatTime(event.received_at)}</div>
        </div>
        <div class="event-details">
          <div><strong>Resource GID:</strong> ${event.resource_gid || 'N/A'}</div>
          ${event.resource_name ? `<div><strong>Name:</strong> ${event.resource_name}</div>` : ''}
          ${event.user ? `<div><strong>User:</strong> ${event.user.name || event.user.gid}</div>` : ''}
          <div><strong>Created:</strong> ${formatTime(event.created_at)}</div>
        </div>
        <div class="toggle-details" onclick="toggleRawData(this)">
          üîç Show raw JSON
        </div>
        <pre class="event-raw">${JSON.stringify(event.full_event, null, 2)}</pre>
      `;

      // Insert at the beginning
      eventList.insertBefore(eventItem, eventList.firstChild);

      // Remove "new" class after animation
      if (isNew) {
        setTimeout(() => {
          eventItem.classList.remove('new');
        }, 500);
      }
    }

    function displayHandshake(data) {
      const eventList = document.getElementById('eventList');
      
      const emptyState = eventList.querySelector('.empty-state');
      if (emptyState) {
        emptyState.remove();
      }

      const item = document.createElement('div');
      item.className = 'event-item';
      item.style.borderLeftColor = '#ed8936';
      
      item.innerHTML = `
        <div class="event-header">
          <div class="event-title">ü§ù Webhook Handshake</div>
          <div class="event-time">${formatTime(data.timestamp)}</div>
        </div>
        <div class="alert alert-success">
          Webhook handshake completed successfully! Hook Secret: ${data.hookSecret}
        </div>
      `;

      eventList.insertBefore(item, eventList.firstChild);
    }

    function toggleRawData(element) {
      const rawDiv = element.nextElementSibling;
      const isShowing = rawDiv.classList.contains('show');
      
      if (isShowing) {
        rawDiv.classList.remove('show');
        element.textContent = 'üîç Show raw JSON';
      } else {
        rawDiv.classList.add('show');
        element.textContent = 'üîº Hide raw JSON';
      }
    }

    function clearEvents() {
      if (!confirm('Clear all events from history?')) return;

      fetch('/api/events/clear', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          console.log('‚úÖ Events cleared:', data);
        })
        .catch(error => {
          console.error('‚ùå Error clearing events:', error);
        });
    }

    function clearEventList() {
      const eventList = document.getElementById('eventList');
      eventList.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">‚ú®</div>
          <h3>History cleared</h3>
          <p>Waiting for new events...</p>
        </div>
      `;
      eventCount = 0;
      updateEventCount();
    }

    function updateConnectionStatus(connected) {
      const badge = document.getElementById('connectionStatus');
      if (connected) {
        badge.textContent = 'üü¢ Connected';
        badge.className = 'status-badge status-connected';
      } else {
        badge.textContent = 'üî¥ Disconnected';
        badge.className = 'status-badge status-disconnected';
      }
    }

    function updateEventCount() {
      document.getElementById('eventCount').textContent = eventCount;
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleString();
    }

    function getActionIcon(action) {
      const icons = {
        'added': '‚ûï',
        'removed': '‚ûñ',
        'changed': '‚úèÔ∏è',
        'deleted': 'üóëÔ∏è',
        'undeleted': '‚ôªÔ∏è'
      };
      return icons[action] || 'üìù';
    }

    function getResourceIcon(type) {
      const icons = {
        'task': '‚úÖ',
        'project': 'üìÅ',
        'story': 'üí¨',
        'tag': 'üè∑Ô∏è',
        'workspace': 'üè¢'
      };
      return icons[type] || 'üìÑ';
    }

    // Start connection
    connectSSE();

    // ============================================
    // TAB MANAGEMENT
    // ============================================

    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(`tab-${tabName}`).classList.add('active');
      event.target.classList.add('active');

      // Load data for the tab
      if (tabName === 'database') {
        refreshDatabase();
      } else if (tabName === 'stats') {
        refreshStats();
      } else if (tabName === 'enriched') {
        checkDCTConnection();
        refreshEnriched();
      }
    }

    // ============================================
    // DATABASE HISTORY TAB
    // ============================================

    function refreshDatabase() {
      currentPage = 0;
      loadDatabaseEvents();
    }

    function loadDatabaseEvents() {
      const pageSize = parseInt(document.getElementById('pageSize').value);
      const offset = currentPage * pageSize;
      
      // Get filters
      currentFilters.resourceType = document.getElementById('filterResourceType').value;
      currentFilters.action = document.getElementById('filterAction').value;
      currentFilters.resourceGid = document.getElementById('filterResourceGid').value;

      // Build query params
      const params = new URLSearchParams({
        limit: pageSize,
        offset: offset
      });

      // Show loading
      const listElement = document.getElementById('databaseEventList');
      listElement.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading events from database...</p>
        </div>
      `;

      fetch(`/api/events/database?${params}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            displayDatabaseEvents(data.events);
            updatePagination(data.events.length, pageSize, data.total, data.hasMore);
          } else {
            listElement.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">‚ùå</div>
                <h3>Error loading events</h3>
                <p>${data.error}</p>
              </div>
            `;
          }
        })
        .catch(error => {
          console.error('Error loading database events:', error);
          listElement.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">‚ùå</div>
              <h3>Error loading events</h3>
              <p>${error.message}</p>
            </div>
          `;
        });
    }

    function displayDatabaseEvents(events) {
      const listElement = document.getElementById('databaseEventList');
      
      if (events.length === 0) {
        listElement.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <h3>No events found</h3>
            <p>No events in database matching the filters</p>
          </div>
        `;
        return;
      }

      // Filter events based on current filters
      let filteredEvents = events;
      if (currentFilters.resourceType) {
        filteredEvents = filteredEvents.filter(e => e.resource_type === currentFilters.resourceType);
      }
      if (currentFilters.action) {
        filteredEvents = filteredEvents.filter(e => e.action === currentFilters.action);
      }
      if (currentFilters.resourceGid) {
        filteredEvents = filteredEvents.filter(e => 
          e.resource_gid && e.resource_gid.includes(currentFilters.resourceGid)
        );
      }

      listElement.innerHTML = '';
      
      filteredEvents.forEach(event => {
        const eventItem = document.createElement('div');
        eventItem.className = 'event-item';
        
        const actionIcon = getActionIcon(event.action);
        const resourceIcon = getResourceIcon(event.resource_type);
        
        // Parse payload if it's a string
        let payload = event.payload;
        if (typeof payload === 'string') {
          try {
            payload = JSON.parse(payload);
          } catch (e) {
            payload = event.payload;
          }
        }

        const resourceName = payload?.resource?.name || payload?.name || 'N/A';
        const userName = payload?.user?.name || payload?.user?.gid || 'N/A';

        eventItem.innerHTML = `
          <div class="event-header">
            <div class="event-title">
              ${actionIcon} ${event.action} - ${resourceIcon} ${event.resource_type}
              ${event.signature_verified ? '‚úÖ' : '‚ö†Ô∏è'}
            </div>
            <div class="event-time">${formatTime(event.received_at)}</div>
          </div>
          <div class="event-details">
            <div><strong>ID:</strong> ${event.id}</div>
            <div><strong>Resource GID:</strong> ${event.resource_gid || 'N/A'}</div>
            <div><strong>Resource Name:</strong> ${resourceName}</div>
            <div><strong>User:</strong> ${userName}</div>
            <div><strong>Created:</strong> ${formatTime(event.created_at)}</div>
            <div><strong>Received:</strong> ${formatTime(event.received_at)}</div>
            <div><strong>Verified:</strong> ${event.signature_verified ? '‚úÖ Yes' : '‚ö†Ô∏è No'}</div>
          </div>
          <div class="toggle-details" onclick="toggleRawData(this)">
            üîç Show raw JSON
          </div>
          <pre class="event-raw">${JSON.stringify(payload, null, 2)}</pre>
        `;

        listElement.appendChild(eventItem);
      });
    }

    function updatePagination(eventsCount, pageSize, total, hasMore) {
      const pagination = document.getElementById('pagination');
      const pageStart = document.getElementById('pageStart');
      const pageEnd = document.getElementById('pageEnd');
      const btnPrev = document.getElementById('btnPrev');
      const btnNext = document.getElementById('btnNext');

      if (eventsCount === 0) {
        pagination.style.display = 'none';
        return;
      }

      pagination.style.display = 'flex';
      
      const start = currentPage * pageSize + 1;
      const end = start + eventsCount - 1;
      
      pageStart.textContent = start;
      pageEnd.textContent = end;
      document.getElementById('totalEvents').textContent = total || (end + (hasMore ? '+' : ''));

      btnPrev.disabled = currentPage === 0;
      btnNext.disabled = !hasMore;
    }

    function previousPage() {
      if (currentPage > 0) {
        currentPage--;
        loadDatabaseEvents();
      }
    }

    function nextPage() {
      currentPage++;
      loadDatabaseEvents();
    }

    // ============================================
    // STATISTICS TAB
    // ============================================

    function refreshStats() {
      const statsContent = document.getElementById('statsContent');
      
      statsContent.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading statistics...</p>
        </div>
      `;

      Promise.all([
        fetch('/api/database/stats').then(r => r.json()),
        fetch('/api/webhooks').then(r => r.json())
      ])
      .then(([statsData, webhooksData]) => {
        displayStats(statsData.stats, webhooksData.webhooks);
      })
      .catch(error => {
        console.error('Error loading stats:', error);
        statsContent.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ùå</div>
            <h3>Error loading statistics</h3>
            <p>${error.message}</p>
          </div>
        `;
      });
    }

    function displayStats(stats, webhooks) {
      const statsContent = document.getElementById('statsContent');
      
      const html = `
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Total Events (DB)</h3>
            <div class="stat-value">${stats?.total_events || 0}</div>
          </div>
          <div class="stat-card">
            <h3>Events (24h)</h3>
            <div class="stat-value">${stats?.events_24h || 0}</div>
          </div>
          <div class="stat-card">
            <h3>Active Webhooks</h3>
            <div class="stat-value">${stats?.active_webhooks || 0}</div>
          </div>
          <div class="stat-card">
            <h3>Verified Events</h3>
            <div class="stat-value">${stats?.verified_events || 0}</div>
          </div>
        </div>

        <h3 style="margin: 20px 0 15px 0; color: #333;">üìã Registered Webhooks</h3>
        <div id="webhooksList">
          ${webhooks && webhooks.length > 0 ? 
            webhooks.map(webhook => `
              <div class="event-item" style="border-left-color: ${webhook.active ? '#48bb78' : '#cbd5e0'}">
                <div class="event-header">
                  <div class="event-title">
                    ${webhook.active ? 'üü¢' : '‚ö´'} ${webhook.resource_type}
                  </div>
                  <div class="event-time">${formatTime(webhook.created_at)}</div>
                </div>
                <div class="event-details">
                  <div><strong>Webhook GID:</strong> ${webhook.webhook_gid}</div>
                  <div><strong>Resource GID:</strong> ${webhook.resource_gid}</div>
                  <div><strong>Target URL:</strong> ${webhook.target_url}</div>
                  <div><strong>Event Count:</strong> ${webhook.event_count || 0}</div>
                  <div><strong>Last Event:</strong> ${webhook.last_event_at ? formatTime(webhook.last_event_at) : 'Never'}</div>
                  <div><strong>Active:</strong> ${webhook.active ? '‚úÖ Yes' : '‚ùå No'}</div>
                </div>
              </div>
            `).join('') :
            '<div class="empty-state"><p>No webhooks registered yet</p></div>'
          }
        </div>
      `;
      
      statsContent.innerHTML = html;
    }

    // ============================================
    // ENRICHED EVENTS TAB
    // ============================================

    async function checkDCTConnection() {
      try {
        const response = await fetch('/api/dct/test');
        const data = await response.json();
        
        const statusEl = document.getElementById('dct-status-text');
        const statusCard = document.getElementById('dct-connection-status');
        
        if (data.success) {
          dctConnected = true;
          statusEl.textContent = `‚úÖ Connected to ${data.database} (${data.time})`;
          statusCard.className = 'alert alert-success';
        } else {
          dctConnected = false;
          statusEl.textContent = `‚ùå Not connected: ${data.error || 'Unknown error'}`;
          statusCard.className = 'alert alert-info';
          statusCard.style.background = '#fed7d7';
          statusCard.style.borderLeftColor = '#f56565';
        }
      } catch (error) {
        console.error('Error checking DCT connection:', error);
        dctConnected = false;
        document.getElementById('dct-status-text').textContent = '‚ùå Connection failed';
      }
    }

    function refreshEnriched() {
      currentPageEnriched = 0;
      loadEnrichedEvents();
    }

    function loadEnrichedEvents() {
      const pageSize = parseInt(document.getElementById('pageSizeEnriched').value);
      const offset = currentPageEnriched * pageSize;
      const resourceType = document.getElementById('filterResourceTypeEnriched').value;
      const action = document.getElementById('filterActionEnriched').value;
      const showOnlyMapped = document.getElementById('showOnlyMapped').checked;
      
      const params = new URLSearchParams({
        limit: pageSize,
        offset: offset
      });
      
      if (resourceType) params.append('resource_type', resourceType);
      if (action) params.append('action', action);

      const listElement = document.getElementById('enrichedEventList');
      listElement.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>Loading enriched events...</p>
        </div>
      `;

      fetch(`/api/events/enriched?${params}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            let events = data.events;
            
            // Filter to only show mapped if checkbox is checked
            if (showOnlyMapped) {
              events = events.filter(e => e.enrichment && e.enrichment.found);
            }
            
            displayEnrichedEvents(events);
            updatePaginationEnriched(events.length, pageSize, data.total, data.hasMore);
          } else {
            listElement.innerHTML = `
              <div class="empty-state">
                <div class="empty-state-icon">‚ùå</div>
                <h3>Error loading enriched events</h3>
                <p>${data.error}</p>
              </div>
            `;
          }
        })
        .catch(error => {
          console.error('Error loading enriched events:', error);
          listElement.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">‚ùå</div>
              <h3>Error loading enriched events</h3>
              <p>${error.message}</p>
            </div>
          `;
        });
    }

    function displayEnrichedEvents(events) {
      const listElement = document.getElementById('enrichedEventList');
      
      if (events.length === 0) {
        listElement.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <h3>No events found</h3>
            <p>No enriched events matching the filters</p>
          </div>
        `;
        return;
      }

      listElement.innerHTML = '';
      
      events.forEach(event => {
        const eventItem = document.createElement('div');
        eventItem.className = 'event-item';
        
        const actionIcon = getActionIcon(event.action);
        const resourceIcon = getResourceIcon(event.resource_type);
        
        const enriched = event.enrichment;
        const enrichmentBadge = enriched && enriched.found
          ? '<span class="enrichment-badge enrichment-found">‚úÖ Found in DCT</span>'
          : '<span class="enrichment-badge enrichment-not-found">‚ùå Not in DCT</span>';

        let enrichedContent = '';
        
        if (enriched && enriched.found && enriched.data) {
          enrichedContent = buildEnrichedContent(enriched.data);
        }

        eventItem.innerHTML = `
          <div class="event-header">
            <div class="event-title">
              ${actionIcon} ${event.action} - ${resourceIcon} ${event.resource_type}
              ${event.signature_verified ? '‚úÖ' : '‚ö†Ô∏è'}
              ${enrichmentBadge}
            </div>
            <div class="event-time">${formatTime(event.received_at)}</div>
          </div>
          <div class="event-details">
            <div><strong>ID:</strong> ${event.id}</div>
            <div><strong>Resource GID:</strong> ${event.resource_gid || 'N/A'}</div>
            <div><strong>Created:</strong> ${formatTime(event.created_at)}</div>
            <div><strong>Received:</strong> ${formatTime(event.received_at)}</div>
            <div><strong>Verified:</strong> ${event.signature_verified ? '‚úÖ Yes' : '‚ö†Ô∏è No'}</div>
          </div>
          ${enrichedContent}
          <div class="toggle-details" onclick="toggleRawData(this)">
            üîç Show raw JSON
          </div>
          <pre class="event-raw">${JSON.stringify(event.original_payload, null, 2)}</pre>
        `;

        listElement.appendChild(eventItem);
      });
    }

    function buildEnrichedContent(data) {
      if (!data) return '';
      
      let html = '<div class="enriched-data">';
      
      if (data.type === 'task') {
        html += '<div class="enriched-section">';
        html += '<h4>üìã Task Information</h4>';
        html += '<div class="enriched-grid">';
        html += `<div class="enriched-label">Name:</div><div class="enriched-value">${data.task.task_name || 'N/A'}</div>`;
        html += `<div class="enriched-label">Completed:</div><div class="enriched-value">${data.task.completed ? '‚úÖ Yes' : '‚ùå No'}</div>`;
        if (data.task.assignee_name) {
          html += `<div class="enriched-label">Assignee:</div><div class="enriched-value">${data.task.assignee_name}</div>`;
        }
        if (data.task.due_on) {
          html += `<div class="enriched-label">Due Date:</div><div class="enriched-value">${data.task.due_on}</div>`;
        }
        if (data.task.permalink_url) {
          html += `<div class="enriched-label">Link:</div><div class="enriched-value"><a href="${data.task.permalink_url}" target="_blank">Open in Asana ‚Üí</a></div>`;
        }
        html += '</div></div>';

        if (data.customer) {
          html += '<div class="enriched-section">';
          html += '<h4>üë§ Customer Information</h4>';
          html += `<div style="margin-bottom: 8px;"><span class="customer-badge">üè¶ ${data.customer.name}</span></div>`;
          html += '<div class="enriched-grid">';
          html += `<div class="enriched-label">CIF:</div><div class="enriched-value">${data.customer.cif || 'N/A'}</div>`;
          html += `<div class="enriched-label">UUID:</div><div class="enriched-value">${data.customer.uuid || 'N/A'}</div>`;
          if (data.customer.total_amount) {
            html += `<div class="enriched-label">Total Amount:</div><div class="enriched-value">${formatCurrency(data.customer.total_amount)}</div>`;
          }
          if (data.customer.principal_amount) {
            html += `<div class="enriched-label">Principal:</div><div class="enriched-value">${formatCurrency(data.customer.principal_amount)}</div>`;
          }
          html += '</div></div>';
        }

        html += '<div class="enriched-section">';
        html += '<h4>üìÅ Project Information</h4>';
        html += '<div class="enriched-grid">';
        html += `<div class="enriched-label">Project:</div><div class="enriched-value">${data.project.name || 'N/A'}</div>`;
        html += `<div class="enriched-label">Workspace:</div><div class="enriched-value">${data.workspace.name || 'N/A'}</div>`;
        html += '</div></div>';

      } else if (data.type === 'project') {
        html += '<div class="enriched-section">';
        html += '<h4>üìÅ Project Information</h4>';
        html += '<div class="enriched-grid">';
        html += `<div class="enriched-label">Name:</div><div class="enriched-value">${data.project.name || 'N/A'}</div>`;
        html += `<div class="enriched-label">Workspace:</div><div class="enriched-value">${data.workspace.name || 'N/A'}</div>`;
        html += `<div class="enriched-label">Archived:</div><div class="enriched-value">${data.project.archived ? '‚úÖ Yes' : '‚ùå No'}</div>`;
        if (data.project.owner_name) {
          html += `<div class="enriched-label">Owner:</div><div class="enriched-value">${data.project.owner_name}</div>`;
        }
        if (data.project.team_name) {
          html += `<div class="enriched-label">Team:</div><div class="enriched-value">${data.project.team_name}</div>`;
        }
        html += `<div class="enriched-label">Tasks:</div><div class="enriched-value">${data.stats.task_count || 0}</div>`;
        html += `<div class="enriched-label">Customers:</div><div class="enriched-value">${data.stats.customer_count || 0}</div>`;
        html += '</div></div>';

      } else if (data.type === 'workspace') {
        html += '<div class="enriched-section">';
        html += '<h4>üè¢ Workspace Information</h4>';
        html += '<div class="enriched-grid">';
        html += `<div class="enriched-label">Name:</div><div class="enriched-value">${data.workspace.name || 'N/A'}</div>`;
        html += `<div class="enriched-label">Organization:</div><div class="enriched-value">${data.workspace.is_organization ? '‚úÖ Yes' : '‚ùå No'}</div>`;
        html += '</div></div>';
      }
      
      html += '</div>';
      return html;
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND'
      }).format(amount);
    }

    function updatePaginationEnriched(eventsCount, pageSize, total, hasMore) {
      const pagination = document.getElementById('paginationEnriched');
      const pageStart = document.getElementById('pageStartEnriched');
      const pageEnd = document.getElementById('pageEndEnriched');
      const btnPrev = document.getElementById('btnPrevEnriched');
      const btnNext = document.getElementById('btnNextEnriched');

      if (eventsCount === 0) {
        pagination.style.display = 'none';
        return;
      }

      pagination.style.display = 'flex';
      
      const start = currentPageEnriched * pageSize + 1;
      const end = start + eventsCount - 1;
      
      pageStart.textContent = start;
      pageEnd.textContent = end;
      document.getElementById('totalEnrichedEvents').textContent = total || (end + (hasMore ? '+' : ''));

      btnPrev.disabled = currentPageEnriched === 0;
      btnNext.disabled = !hasMore;
    }

    function previousPageEnriched() {
      if (currentPageEnriched > 0) {
        currentPageEnriched--;
        loadEnrichedEvents();
      }
    }

    function nextPageEnriched() {
      currentPageEnriched++;
      loadEnrichedEvents();
    }
  </script>
</body>
</html>

