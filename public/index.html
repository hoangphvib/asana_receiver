<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asana Webhook Receiver - Real-time Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 20px 30px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .header h1 {
      color: #333;
      margin-bottom: 10px;
    }

    .status {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .status-badge {
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 14px;
      font-weight: 500;
    }

    .status-connected {
      background: #c6f6d5;
      color: #22543d;
    }

    .status-disconnected {
      background: #fed7d7;
      color: #742a2a;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .card h2 {
      color: #333;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-danger {
      background: #f56565;
      color: white;
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .event-list {
      max-height: 600px;
      overflow-y: auto;
    }

    .event-item {
      background: #f7fafc;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
      transition: all 0.3s;
    }

    .event-item:hover {
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .event-item.new {
      animation: slideIn 0.5s ease-out;
      border-left-color: #48bb78;
    }

    @keyframes slideIn {
      from {
        transform: translateX(-20px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .event-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 10px;
    }

    .event-title {
      font-weight: 600;
      color: #2d3748;
      font-size: 16px;
    }

    .event-time {
      font-size: 12px;
      color: #718096;
    }

    .event-details {
      font-size: 14px;
      color: #4a5568;
      line-height: 1.6;
    }

    .event-details div {
      margin-bottom: 5px;
    }

    .event-details strong {
      color: #2d3748;
      margin-right: 5px;
    }

    .toggle-details {
      margin-top: 10px;
      font-size: 13px;
      color: #667eea;
      cursor: pointer;
      user-select: none;
    }

    .toggle-details:hover {
      text-decoration: underline;
    }

    .event-raw {
      margin-top: 10px;
      padding: 10px;
      background: #1e1e1e;
      color: #d4d4d4;
      border-radius: 5px;
      font-size: 12px;
      overflow-x: auto;
      display: none;
    }

    .event-raw.show {
      display: block;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #718096;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .alert {
      padding: 12px 15px;
      border-radius: 5px;
      margin-bottom: 15px;
    }

    .alert-info {
      background: #bee3f8;
      border-left: 4px solid #3182ce;
      color: #2c5282;
    }

    .alert-success {
      background: #c6f6d5;
      border-left: 4px solid #38a169;
      color: #22543d;
    }

    footer {
      text-align: center;
      color: white;
      margin-top: 30px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîî Asana Webhook Receiver - Real-time Dashboard</h1>
      <div class="status">
        <span class="status-badge" id="connectionStatus">Connecting...</span>
        <span style="color: #718096;">Events received: <strong id="eventCount">0</strong></span>
        <span style="color: #718096;">Connected clients: <strong id="clientCount">1</strong></span>
      </div>
    </div>

    <div class="card">
      <div class="alert alert-info">
        <strong>üì° Live Connection:</strong> This dashboard shows webhook events in real-time via Server-Sent Events (SSE).
        Events are automatically pushed from the server as they arrive from Asana.
      </div>
      <div id="urlInfo" style="margin-top: 10px; padding: 12px; background: #f7fafc; border-radius: 5px; font-size: 14px;">
        <strong>üîó Quick Copy URLs:</strong>
        <div style="margin-top: 8px; display: flex; flex-direction: column; gap: 8px;">
          <div>
            <strong>Webhook Endpoint:</strong> 
            <code id="webhookUrl" style="background: white; padding: 4px 8px; border-radius: 3px; cursor: pointer;" onclick="copyUrl('webhookUrl')">
              Loading...
            </code>
            <button class="btn btn-primary" style="margin-left: 8px; padding: 4px 12px; font-size: 12px;" onclick="copyUrl('webhookUrl')">
              üìã Copy
            </button>
          </div>
          <div>
            <strong>Dashboard URL:</strong> 
            <code id="dashboardUrl" style="background: white; padding: 4px 8px; border-radius: 3px; cursor: pointer;" onclick="copyUrl('dashboardUrl')">
              Loading...
            </code>
            <button class="btn btn-primary" style="margin-left: 8px; padding: 4px 12px; font-size: 12px;" onclick="copyUrl('dashboardUrl')">
              üìã Copy
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>
        <span>üì® Recent Events</span>
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-primary" onclick="clearEvents()">üóëÔ∏è Clear History</button>
        </div>
      </h2>
      
      <div id="eventList" class="event-list">
        <div class="empty-state">
          <div class="empty-state-icon">‚è≥</div>
          <h3>Waiting for webhook events...</h3>
          <p>Events will appear here automatically when received from Asana</p>
        </div>
      </div>
    </div>

    <footer>
      <p>Asana Webhook Receiver with SSE | Real-time Event Streaming</p>
    </footer>
  </div>

  <script>
    let eventSource = null;
    let eventCount = 0;

    // Function to copy URL to clipboard
    function copyUrl(elementId) {
      const element = document.getElementById(elementId);
      const text = element.textContent.trim();
      
      if (text === 'Loading...') return;
      
      navigator.clipboard.writeText(text).then(() => {
        const btn = element.nextElementSibling;
        const originalText = btn.textContent;
        btn.textContent = '‚úÖ Copied!';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy URL');
      });
    }

    // Fetch server info to get PUBLIC_URL
    fetch('/api/info')
      .then(res => res.json())
      .then(data => {
        if (data.urls) {
          document.getElementById('webhookUrl').textContent = data.urls.webhook_endpoint;
          document.getElementById('dashboardUrl').textContent = data.urls.dashboard;
        }
      })
      .catch(err => {
        console.error('Failed to fetch server info:', err);
        document.getElementById('webhookUrl').textContent = window.location.origin + '/webhook';
        document.getElementById('dashboardUrl').textContent = window.location.origin;
      });

    // Connect to SSE endpoint
    function connectSSE() {
      eventSource = new EventSource('/events');

      eventSource.onopen = () => {
        console.log('‚úÖ SSE Connected');
        updateConnectionStatus(true);
      };

      eventSource.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data);
          handleServerMessage(data);
        } catch (error) {
          console.error('Error parsing SSE message:', error);
        }
      };

      eventSource.onerror = (error) => {
        console.error('‚ùå SSE Error:', error);
        updateConnectionStatus(false);
        
        // Reconnect after 5 seconds
        setTimeout(() => {
          console.log('üîÑ Reconnecting...');
          connectSSE();
        }, 5000);
      };
    }

    function handleServerMessage(data) {
      console.log('üì® Server message:', data.type, data);

      switch (data.type) {
        case 'connected':
          console.log('‚úÖ Connected to server');
          break;

        case 'history':
          console.log(`üìö Received ${data.count} historical events`);
          data.events.forEach(event => displayEvent(event, false));
          break;

        case 'webhook_event':
          console.log('üîî New webhook event:', data.event);
          displayEvent(data.event, true);
          eventCount++;
          updateEventCount();
          break;

        case 'handshake':
          displayHandshake(data);
          break;

        case 'history_cleared':
          clearEventList();
          break;

        default:
          console.log('Unknown message type:', data.type);
      }
    }

    function displayEvent(event, isNew = false) {
      const eventList = document.getElementById('eventList');
      
      // Remove empty state if exists
      const emptyState = eventList.querySelector('.empty-state');
      if (emptyState) {
        emptyState.remove();
      }

      const eventItem = document.createElement('div');
      eventItem.className = `event-item ${isNew ? 'new' : ''}`;
      
      const actionIcon = getActionIcon(event.action);
      const resourceIcon = getResourceIcon(event.resource_type);

      eventItem.innerHTML = `
        <div class="event-header">
          <div class="event-title">
            ${actionIcon} ${event.action} - ${resourceIcon} ${event.resource_type}
          </div>
          <div class="event-time">${formatTime(event.received_at)}</div>
        </div>
        <div class="event-details">
          <div><strong>Resource GID:</strong> ${event.resource_gid || 'N/A'}</div>
          ${event.resource_name ? `<div><strong>Name:</strong> ${event.resource_name}</div>` : ''}
          ${event.user ? `<div><strong>User:</strong> ${event.user.name || event.user.gid}</div>` : ''}
          <div><strong>Created:</strong> ${formatTime(event.created_at)}</div>
        </div>
        <div class="toggle-details" onclick="toggleRawData(this)">
          üîç Show raw JSON
        </div>
        <pre class="event-raw">${JSON.stringify(event.full_event, null, 2)}</pre>
      `;

      // Insert at the beginning
      eventList.insertBefore(eventItem, eventList.firstChild);

      // Remove "new" class after animation
      if (isNew) {
        setTimeout(() => {
          eventItem.classList.remove('new');
        }, 500);
      }
    }

    function displayHandshake(data) {
      const eventList = document.getElementById('eventList');
      
      const emptyState = eventList.querySelector('.empty-state');
      if (emptyState) {
        emptyState.remove();
      }

      const item = document.createElement('div');
      item.className = 'event-item';
      item.style.borderLeftColor = '#ed8936';
      
      item.innerHTML = `
        <div class="event-header">
          <div class="event-title">ü§ù Webhook Handshake</div>
          <div class="event-time">${formatTime(data.timestamp)}</div>
        </div>
        <div class="alert alert-success">
          Webhook handshake completed successfully! Hook Secret: ${data.hookSecret}
        </div>
      `;

      eventList.insertBefore(item, eventList.firstChild);
    }

    function toggleRawData(element) {
      const rawDiv = element.nextElementSibling;
      const isShowing = rawDiv.classList.contains('show');
      
      if (isShowing) {
        rawDiv.classList.remove('show');
        element.textContent = 'üîç Show raw JSON';
      } else {
        rawDiv.classList.add('show');
        element.textContent = 'üîº Hide raw JSON';
      }
    }

    function clearEvents() {
      if (!confirm('Clear all events from history?')) return;

      fetch('/api/events/clear', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          console.log('‚úÖ Events cleared:', data);
        })
        .catch(error => {
          console.error('‚ùå Error clearing events:', error);
        });
    }

    function clearEventList() {
      const eventList = document.getElementById('eventList');
      eventList.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">‚ú®</div>
          <h3>History cleared</h3>
          <p>Waiting for new events...</p>
        </div>
      `;
      eventCount = 0;
      updateEventCount();
    }

    function updateConnectionStatus(connected) {
      const badge = document.getElementById('connectionStatus');
      if (connected) {
        badge.textContent = 'üü¢ Connected';
        badge.className = 'status-badge status-connected';
      } else {
        badge.textContent = 'üî¥ Disconnected';
        badge.className = 'status-badge status-disconnected';
      }
    }

    function updateEventCount() {
      document.getElementById('eventCount').textContent = eventCount;
    }

    function formatTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleString();
    }

    function getActionIcon(action) {
      const icons = {
        'added': '‚ûï',
        'removed': '‚ûñ',
        'changed': '‚úèÔ∏è',
        'deleted': 'üóëÔ∏è',
        'undeleted': '‚ôªÔ∏è'
      };
      return icons[action] || 'üìù';
    }

    function getResourceIcon(type) {
      const icons = {
        'task': '‚úÖ',
        'project': 'üìÅ',
        'story': 'üí¨',
        'tag': 'üè∑Ô∏è',
        'workspace': 'üè¢'
      };
      return icons[type] || 'üìÑ';
    }

    // Start connection
    connectSSE();
  </script>
</body>
</html>

